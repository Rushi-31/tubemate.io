<!DOCTYPE html>
<html lang="en" data-theme="">
<head>
  <meta charset="UTF-8" />
  <title>Tubemate Pro â€” Fast Local YouTube Downloader</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Self-hosted YouTube downloader using yt-dlp + ffmpeg. Choose quality and auto-mux video+audio. Playlists <=720p.">
  <style>
    /* Theme tokens */
    :root {
      --bg: #0b1220;
      --panel: #111a2b;
      --muted: #8aa0c5;
      --text: #e9f0ff;
      --accent: #7c9cff;
      --accent-2: #16d2aa;
      --danger: #ff6b6b;
      --border: #22314f;
      --chip: #18233a;
      --link: #9bb4ff;
      --shadow: 0 12px 50px rgba(0,0,0,0.25);
      --panel-grad: linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
      --page-grad: radial-gradient(1200px 700px at 20% -10%, #12203a 0%, #0b1220 60%);
    }
    :root.light {
      --bg: #f6f8fc;
      --panel: #ffffff;
      --muted: #5a6a85;
      --text: #0f172a;
      --accent: #4c6cff;
      --accent-2: #14b8a6;
      --danger: #e11d48;
      --border: #e5e7eb;
      --chip: #eef2ff;
      --link: #1d4ed8;
      --shadow: 0 12px 40px rgba(0,0,0,0.08);
      --panel-grad: linear-gradient(180deg, rgba(0,0,0,0.02), transparent);
      --page-grad: radial-gradient(1200px 700px at 20% -10%, #eaf0ff 0%, #f6f8fc 60%);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: var(--page-grad), var(--bg);
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial;
      line-height: 1.5;
    }
    a { color: var(--link); text-decoration: none; }
    a:hover { text-decoration: underline; }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 0 16px 60px; }
    header {
      position: sticky; top: 0; z-index: 50;
      background: color-mix(in srgb, var(--bg) 70%, transparent);
      backdrop-filter: blur(8px);
      border-bottom: 1px solid color-mix(in srgb, var(--border) 80%, transparent);
    }
    .nav { display: flex; align-items: center; justify-content: space-between; gap: 12px; padding: 12px 0; }
    .brand { display: flex; align-items: center; gap: 10px; }
    .logo {
      width: 50px; height: 50px; border-radius: 10px;
      display: grid; place-items: center; overflow: hidden;
    }
    .logo img { width: 100%; height: 100%; object-fit: contain; display: block; padding: 4px; }
    .brand h1 { font-size: 18px; margin: 0; }
    .menu { display: flex; gap: 6px; flex-wrap: wrap; align-items: center; }
    .menu a {
      padding: 8px 12px; border-radius: 10px; border: 1px solid transparent; color: var(--text);
    }
    .menu a.active, .menu a:hover { background: color-mix(in srgb, var(--panel) 88%, transparent); border-color: var(--border); }
    .mode-toggle {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 6px 10px; border-radius: 10px; border: 1px solid var(--border);
      background: color-mix(in srgb, var(--panel) 90%, transparent);
      cursor: pointer; user-select: none;
    }

    /* Sections */
    .section {
      background: var(--panel-grad), var(--panel);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 18px;
      box-shadow: var(--shadow);
      margin: 18px 0;
    }
    .grid { display: grid; grid-template-columns: 1.2fr .8fr; gap: 16px; }
    @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }
    label { display: block; font-weight: 600; font-size: 13px; margin-bottom: 8px; color: color-mix(in srgb, var(--text) 92%, transparent); }
    input[type=text] {
      width: 100%; padding: 12px 14px; background: color-mix(in srgb, var(--panel) 90%, transparent); border: 1px solid var(--border);
      border-radius: 10px; color: var(--text); outline: none;
    }
    input[type=text]::placeholder { color: var(--muted); }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .buttons { display: flex; gap: 10px; flex-wrap: wrap; }
    button {
      padding: 10px 14px; border: 1px solid var(--border); border-radius: 10px;
      background: color-mix(in srgb, var(--panel) 95%, transparent); color: var(--text); font-weight: 600; cursor: pointer;
    }
    button.primary { background: linear-gradient(180deg, var(--accent), color-mix(in srgb, var(--accent) 65%, #0000)); border-color: color-mix(in srgb, var(--accent) 70%, var(--border)); color: #0b1220; }
    button.ghost { background: color-mix(in srgb, var(--panel) 90%, transparent); }
    button:disabled { opacity: .5; cursor: not-allowed; }
    .hint { color: var(--muted); font-size: 12px; margin-top: 10px; }
    .chips { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }
    .chip { padding: 6px 10px; font-size: 12px; color: color-mix(in srgb, var(--text) 92%, transparent); background: var(--chip); border: 1px solid var(--border); border-radius: 999px; }
    .split { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    select {
      width: 100%; padding: 10px 12px; background: color-mix(in srgb, var(--panel) 90%, transparent); border: 1px solid var(--border);
      border-radius: 10px; color: var(--text);
    }
    .title { font-size: 14px; font-weight: 700; color: color-mix(in srgb, var(--text) 96%, transparent); margin: 8px 0 10px; }
    .status { margin-top: 16px; padding: 12px; border-radius: 10px; background: color-mix(in srgb, var(--panel) 90%, transparent); border: 1px solid var(--border); min-height: 44px; font-size: 13px; }
    .status .progress { height: 8px; background: color-mix(in srgb, var(--border) 40%, transparent); border-radius: 999px; overflow: hidden; margin-top: 10px; }
    .status .bar { height: 100%; width: 0%; background: linear-gradient(90deg, var(--accent-2), var(--accent)); transition: width .2s ease; }
    .error { color: var(--danger); font-weight: 700; }
    .previewBox { min-height:180px; }

    .hero {
      position: relative; overflow: hidden; border-radius: 16px;
      background: var(--panel-grad), var(--panel);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      padding: 28px;
      display: grid; gap: 16px;
      grid-template-columns: 1.1fr .9fr;
    }
    @media (max-width: 980px) { .hero { grid-template-columns: 1fr; } }
    .hero h2 { margin: 6px 0 10px; font-size: 28px; line-height: 1.2; }
    .hero p { margin: 0; color: var(--muted); }
    .hero .badges { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
    .badge { padding: 6px 10px; border: 1px solid var(--border); border-radius: 999px; background: color-mix(in srgb, var(--panel) 90%, transparent); font-size: 12px; color: color-mix(in srgb, var(--text) 92%, transparent); }
    .hero-visual { position: relative; min-height: 220px; border-radius: 12px; overflow: hidden; border: 1px solid var(--border); }
    .hero-visual img { width: 100%; height: 100%; object-fit: cover; }

    .features { display: grid; gap: 14px; grid-template-columns: repeat(3, 1fr); }
    @media (max-width: 980px) { .features { grid-template-columns: 1fr; } }
    .card { background: color-mix(in srgb, var(--panel) 94%, transparent); border: 1px solid var(--border); border-radius: 12px; padding: 14px; }
    .card h3 { margin: 6px 0 6px; }
    .card p { margin: 0; color: var(--muted); font-size: 14px; }
    .card img { width: 100%; border-radius: 8px; margin-bottom: 8px; border: 1px solid var(--border); }

    footer { margin: 24px 0 40px; color: var(--muted); font-size: 12px; text-align: center; }

    /* "Pages" via client-side routing */
    main > section { display: none; }
    main > section.active { display: block; }

    /* Utilities */
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    .spacer { height: 16px; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="nav" role="navigation" aria-label="Main">
        <div class="brand">
          <div class="logo" aria-hidden="true">
            <img src="static/assets/logo.png" alt="" />
          </div>
          <h1>Tubemate Pro</h1>
        </div>
        <nav class="menu">
          <a href="#/downloader" data-route>Downloader</a>
          <a href="#/about" data-route>About</a>
          <a href="#/help" data-route>Help</a>
          <a href="#/settings" data-route>Settings</a>
          <div class="mode-toggle" id="modeToggle" role="button" aria-pressed="false" title="Toggle dark/light">
            <span id="modeIcon">ðŸŒ™</span>
            <span id="modeText">Dark</span>
          </div>
        </nav>
      </div>
    </header>

    <main id="app">
      <!-- PAGE: DOWNLOADER -->
      <section id="page-downloader" aria-label="Downloader">
        <div class="section">
          <div class="grid">
            <div>
              <label for="yturl">Paste YouTube link</label>
              <input id="yturl" type="text" placeholder="https://www.youtube.com/watch?v=... or playlist URL" autocomplete="off" />
              <div class="buttons" style="margin-top:10px">
                <button id="btnGet" class="primary" aria-label="Analyze URL">Analyze</button>
                <button id="btnClear" class="ghost" aria-label="Clear form">Clear</button>
              </div>
              <div class="hint">Single video: choose a quality or custom exact IDs. Weâ€™ll download video+audio and merge. Playlist: auto <=720p.</div>

              <div id="meta" class="chips" style="display:none"></div>

              <div id="qualitySection" style="margin-top:16px; display:none">
                <div class="title">Quality (Single Video)</div>
                <label for="qualitySelect">Choose target quality</label>
                <select id="qualitySelect" aria-label="Quality">
                  <option value="auto1080">1080p (best <=1080p + best audio)</option>
                  <option value="auto720" selected>720p (best <=720p + best audio)</option>
                  <option value="auto480">480p (best <=480p + best audio)</option>
                  <option value="auto360">360p (best <=360p + best audio)</option>
                  <option value="custom">Custom (pick exact video-only + audio-only)</option>
                </select>

                <div id="customFormats" class="split" role="group" aria-label="Custom formats" style="display:none; margin-top:10px">
                  <div>
                    <label for="videoSelect">Video-only (exact format)</label>
                    <select id="videoSelect" aria-label="Video-only formats"></select>
                  </div>
                  <div>
                    <label for="audioSelect">Audio-only (exact format)</label>
                    <select id="audioSelect" aria-label="Audio-only formats"></select>
                  </div>
                </div>
                <div class="hint">Auto options pick the best video-only stream up to the chosen resolution and the best audio-only stream; then mux.</div>
              </div>

              <div id="downloadOptions" style="margin-top:16px; display:none">
                <div class="row">
                  <div>
                    <label for="outDir">Output folder (server path) â€” required</label>
                    <input id="outDir" type="text" placeholder="e.g. ~/Downloads" required aria-required="true" />
                  </div>
                  <div>
                    <label for="mode">Mode</label>
                    <select id="mode" aria-label="Download mode">
                      <option value="single">Single video</option>
                      <option value="playlist">Playlist (<=720p)</option>
                    </select>
                  </div>
                </div>
                <div class="buttons" style="margin-top:12px">
                  <button id="btnDownload" class="primary" disabled aria-disabled="true">Download</button>
                  <button id="btnStop" class="ghost">Stop Stream</button>
                </div>
                <div id="pathError" class="hint" style="color: var(--danger); display:none">Output path is required.</div>
              </div>

              <div id="status" class="status" style="display:none" aria-live="polite">
                <div id="statusText">Waitingâ€¦</div>
                <div class="progress" aria-hidden="true"><div id="bar" class="bar"></div></div>
              </div>
            </div>

            <div>
              <div class="title">Video preview</div>
              <div id="preview" class="section previewBox" style="display:block">
                <div class="hint">Weâ€™ll show thumbnail & title here after Analyze.</div>
                <div id="thumbWrap" style="margin-top:10px; display:none">
                  <img id="thumb" style="max-width:100%; border-radius: 10px; border:1px solid var(--border);" alt="thumbnail" loading="lazy" />
                  <div id="vtitle" style="margin-top:8px; font-weight:700;"></div>
                  <div id="source" class="mono" style="color: var(--muted); font-size:12px; margin-top:4px;">Source: YouTube â€¢ Auto-detected</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <section class="hero" aria-label="Intro">
          <div>
            <h2>Choose Quality, We Download Video+Audio and Merge</h2>
            <p>Select 1080p/720p/480p/360p for single videos â€” weâ€™ll fetch separate video and audio streams and mux with ffmpeg (via yt-dlp). For playlists, we auto-download at <=720p.</p>
            <div class="badges" aria-label="Highlights">
              <span class="badge">yt-dlp + ffmpeg</span>
              <span class="badge">Auto mux</span>
              <span class="badge">Playlist <= 720p</span>
              <span class="badge">Self-hosted & Private</span>
              <span class="badge">Live Progress</span>
            </div>
          </div>
          <div class="hero-visual" aria-hidden="true">
            <img src="static/assets/robot.jpg" alt="" loading="lazy" />
          </div>
        </section>
      </section>

      <!-- PAGE: ABOUT -->
      <section id="page-about" aria-label="About">
        <section class="hero">
          <div>
            <h2>About Tubemate Pro</h2>
            <p>Selfâ€‘hosted, privacyâ€‘first YouTube downloader built on ytâ€‘dlp and ffmpeg. Choose quality presets or custom formats for single videos; playlists auto download at <=720p.</p>
            <div class="badges">
              <span class="badge">Private</span>
              <span class="badge">Fast</span>
              <span class="badge">Reliable</span>
            </div>
          </div>
          <div class="hero-visual" aria-hidden="true">
            <img src="https://images.unsplash.com/photo-1518770660439-4636190af475?q=80&w=1600&auto=format&fit=crop" alt="" loading="lazy" />
          </div>
        </section>

        <section class="section">
          <div class="features">
            <article class="card">
              <img src="https://images.unsplash.com/photo-1518779578993-ec3579fee39f?q=80&w=1400&auto=format&fit=crop" alt="" loading="lazy" />
              <h3>Quality Selection</h3>
              <p>Pick 1080p/720p/480p/360p or choose exact videoâ€‘only and audioâ€‘only formats.</p>
            </article>
            <article class="card">
              <img src="https://images.unsplash.com/photo-1470167290877-7d5d3446de4c?q=80&w=1400&auto=format&fit=crop" alt="" loading="lazy" />
              <h3>Auto Mux</h3>
              <p>We download separate video and audio streams and merge automatically.</p>
            </article>
            <article class="card">
              <img src="https://images.unsplash.com/photo-1447433819943-74a20887a81e?q=80&w=1400&auto=format&fit=crop" alt="" loading="lazy" />
              <h3>Playlist Mode</h3>
              <p>Playlists download at <=720p, organized into subfolders.</p>
            </article>
          </div>
        </section>
      </section>

      <!-- PAGE: HELP -->
      <section id="page-help" aria-label="Help">
        <section class="hero">
          <div>
            <h2>Help & Tips</h2>
            <p>How to analyze links, choose quality, use playlist mode, and troubleshoot common issues.</p>
            <div class="badges">
              <span class="badge">Quick Start</span>
              <span class="badge">FAQ</span>
              <span class="badge">Troubleshooting</span>
            </div>
          </div>
          <div class="hero-visual" aria-hidden="true">
            <img src="https://images.unsplash.com/photo-1520975922284-8b456906c813?q=80&w=1600&auto=format&fit=crop" alt="" loading="lazy" />
          </div>
        </section>

        <section class="section">
          <h3>Quick Start</h3>
          <ol>
            <li>Go to Downloader and paste a YouTube URL. Click Analyze.</li>
            <li>If a playlist is detected, simply click Download (<=720p).</li>
            <li>For a single video, choose a quality or Custom formats, then Download.</li>
            <li>Set the server output folder before starting.</li>
          </ol>

          <div class="spacer"></div>
          <h3>FAQs</h3>
          <ul>
            <li>Why separate video/audio streams? Higher resolutions are split; we mux for you.</li>
            <li>Force a specific format? Use Custom and pick exact IDs (e.g., 137 + 140).</li>
            <li>Where are files saved? The serverâ€™s output folder you specify.</li>
            <li>Stuck at 0%? Check ffmpeg presence and firewall settings for SSE.</li>
          </ul>
        </section>
      </section>

      <!-- PAGE: SETTINGS -->
      <section id="page-settings" aria-label="Settings">
        <section class="section">
          <h2>Settings</h2>
          <p>These settings live only in your browser (local state):</p>
          <div class="row">
            <div>
              <label for="defaultOut">Default Output Folder</label>
              <input id="defaultOut" type="text" placeholder="~/Downloads" />
            </div>
            <div>
              <label for="rememberUrl">Remember Last URL</label>
              <select id="rememberUrl">
                <option value="yes">Yes</option>
                <option value="no">No</option>
              </select>
            </div>
          </div>
          <div class="buttons" style="margin-top:12px">
            <button id="btnSaveSettings" class="primary">Save Settings</button>
            <button id="btnResetSettings" class="ghost">Reset</button>
          </div>
          <p class="hint">No backend storage is used for these preferences.</p>
        </section>
      </section>
    </main>

    <footer>Choose a quality for single videos; we autoâ€‘mux video+audio. Playlists <=720p. Fast, secure, and local â€” powered by ytâ€‘dlp and ffmpeg.</footer>
  </div>

  <script>
    // Theme and nav
    const THEME_KEY = 'tubemate_theme_v1';
    function applyTheme(t) {
      const root = document.documentElement;
      if (t === 'light') root.classList.add('light'); else root.classList.remove('light');
      const isLight = root.classList.contains('light');
      const modeText = document.getElementById('modeText');
      const modeIcon = document.getElementById('modeIcon');
      if (modeText) modeText.textContent = isLight ? 'Light' : 'Dark';
      if (modeIcon) modeIcon.textContent = isLight ? 'â˜€ï¸' : 'ðŸŒ™';
      const toggle = document.getElementById('modeToggle');
      if (toggle) toggle.setAttribute('aria-pressed', String(isLight));
    }
    function initTheme() {
      const saved = localStorage.getItem(THEME_KEY);
      if (saved === 'light' || saved === 'dark') applyTheme(saved);
      else applyTheme(window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark');
    }
    function toggleTheme() {
      const root = document.documentElement;
      const nowLight = !root.classList.contains('light');
      applyTheme(nowLight ? 'light' : 'dark');
      localStorage.setItem(THEME_KEY, nowLight ? 'light' : 'dark');
    }
    document.addEventListener('DOMContentLoaded', () => {
      const t = document.getElementById('modeToggle');
      if (t) t.addEventListener('click', toggleTheme);
      initTheme();
    });

    // Simple client-side router
    const routes = ['downloader','about','help','settings'];
    function setActiveNav(route) {
      document.querySelectorAll('nav.menu a[data-route]').forEach(a => {
        const href = a.getAttribute('href') || '';
        const r = (href.split('#/')[1] || '').toLowerCase();
        a.classList.toggle('active', r === route);
      });
    }
    function renderRoute() {
      let r = (location.hash.startsWith('#/') ? location.hash.slice(2) : 'downloader').toLowerCase();
      if (!routes.includes(r)) r = 'downloader';
      document.querySelectorAll('main > section').forEach(sec => sec.classList.remove('active'));
      const page = document.getElementById('page-' + r);
      if (page) page.classList.add('active');
      setActiveNav(r);
      if (r === 'settings') initSettingsUI();
    }
    window.addEventListener('hashchange', renderRoute);

    // Downloader logic
    const els = {
      yturl: null, btnGet: null, btnClear: null, meta: null, qualitySection: null,
      qualitySelect: null, customFormats: null, videoSelect: null, audioSelect: null,
      downloadOptions: null, outDir: null, mode: null, btnDownload: null, btnStop: null,
      status: null, statusText: null, bar: null, thumbWrap: null, thumb: null, vtitle: null, pathError: null
    };
    let sse = null, lastIsPlaylist = false, cachedTitle = '', analyzedUrl = '';

    function q(id) { return document.getElementById(id); }
    function initDownloaderRefs() {
      els.yturl = q('yturl'); els.btnGet = q('btnGet'); els.btnClear = q('btnClear');
      els.meta = q('meta'); els.qualitySection = q('qualitySection'); els.qualitySelect = q('qualitySelect');
      els.customFormats = q('customFormats'); els.videoSelect = q('videoSelect'); els.audioSelect = q('audioSelect');
      els.downloadOptions = q('downloadOptions'); els.outDir = q('outDir'); els.mode = q('mode');
      els.btnDownload = q('btnDownload'); els.btnStop = q('btnStop'); els.status = q('status'); els.statusText = q('statusText');
      els.bar = q('bar'); els.thumbWrap = q('thumbWrap'); els.thumb = q('thumb'); els.vtitle = q('vtitle'); els.pathError = q('pathError');
    }
    function validatePath() {
      const ok = !!(els.outDir && els.outDir.value.trim());
      if (els.btnDownload) {
        els.btnDownload.disabled = !ok;
        els.btnDownload.setAttribute('aria-disabled', String(!ok));
      }
      if (els.pathError) els.pathError.style.display = ok ? 'none' : 'block';
      return ok;
    }
    function setStatus(msg, pct=null, isError=false) {
      if (!els.status || !els.statusText || !els.bar) return;
      els.status.style.display = 'block';
      els.statusText.textContent = msg;
      els.statusText.className = isError ? 'error' : '';
      if (pct !== null && pct !== undefined) {
        els.bar.style.width = Math.min(100, Math.max(0, pct)) + '%';
      }
    }
    function stopSSE() { if (sse) { sse.close(); sse = null; } }
    function resetUI(hideStatus=false) {
      if (!els.meta) return;
      els.meta.style.display = 'none'; els.meta.innerHTML = '';
      els.qualitySection.style.display = 'none';
      els.customFormats.style.display = 'none';
      els.videoSelect.innerHTML = '';
      els.audioSelect.innerHTML = '';
      els.downloadOptions.style.display = 'none';
      if (hideStatus) { els.status.style.display = 'none'; } else { els.bar.style.width = '0%'; }
      els.thumbWrap.style.display = 'none';
      els.vtitle.textContent = '';
      els.thumb.src = '';
      cachedTitle = ''; lastIsPlaylist = false; analyzedUrl = '';
      stopSSE();
      validatePath();
    }
    function isPlaylistUrl(u) {
      const s = (u || '').toLowerCase();
      return /[?&]list=/.test(s) || /\/playlist/.test(s);
    }
    async function analyze() {
      resetUI();
      const url = els.yturl.value.trim();
      if (!url) { setStatus('Please paste a YouTube link.', null, true); return; }
      analyzedUrl = url;
      setStatus('Analyzingâ€¦', 0);
      try {
        const res = await fetch('/get_formats?url=' + encodeURIComponent(url));
        const data = await res.json();
        if (!res.ok) { setStatus(data.error || 'Failed to analyze link', null, true); return; }

        cachedTitle = data.title || 'video';
        lastIsPlaylist = !!data.is_playlist || isPlaylistUrl(url);

        // chips
        els.meta.style.display = 'flex';
        els.meta.innerHTML = '';
        if (lastIsPlaylist) {
          const chipP = document.createElement('div'); chipP.className = 'chip'; chipP.textContent = 'Detected: Playlist';
          const chipQ = document.createElement('div'); chipQ.className = 'chip'; chipQ.textContent = '<=720p auto';
          els.meta.appendChild(chipP); els.meta.appendChild(chipQ);
        } else {
          const vv = (data.video_formats || []).length;
          const av = (data.audio_formats || []).length;
          const chip2 = document.createElement('div'); chip2.className = 'chip'; chip2.textContent = `${vv} video-only`;
          const chip3 = document.createElement('div'); chip3.className = 'chip'; chip3.textContent = `${av} audio-only`;
          els.meta.appendChild(chip2); els.meta.appendChild(chip3);
        }

        // preview
        els.thumbWrap.style.display = 'block';
        els.vtitle.textContent = cachedTitle;
        try {
          const idMatch = url.match(/[?&]v=([A-Za-z0-9_-]{11})/) || url.match(/youtu\.be\/([A-Za-z0-9_-]{11})/);
          if (idMatch) { els.thumb.src = `https://i.ytimg.com/vi/${idMatch[1]}/hqdefault.jpg`; } else { els.thumbWrap.style.display = 'none'; }
        } catch (_) { els.thumbWrap.style.display = 'none'; }

        // options
        els.downloadOptions.style.display = 'block';
        validatePath();

        if (lastIsPlaylist) {
          els.qualitySection.style.display = 'none';
          els.mode.value = 'playlist';
          setStatus('Playlist detected. Ready to download at <=720p.', 0);
        } else {
          const vids = data.video_formats || [];
          const auds = data.audio_formats || [];
          function labelVideo(f) { return `${f.format_id} â€¢ ${f.height ? f.height+'p' : 'video'} ${f.fps ? f.fps+'fps' : ''} â€¢ .${f.ext} â€¢ ${f.filesize_hr || 'Unknown'}`; }
          function labelAudio(f) { return `${f.format_id} â€¢ ${f.abr ? f.abr+'kbps' : 'audio'} â€¢ .${f.ext} â€¢ ${f.filesize_hr || 'Unknown'}`; }
          els.videoSelect.innerHTML = vids.map(f => `<option value="${f.format_id}">${labelVideo(f)}</option>`).join('');
          els.audioSelect.innerHTML = auds.map(f => `<option value="${f.format_id}">${labelAudio(f)}</option>`).join('');
          els.qualitySection.style.display = 'block';
          els.customFormats.style.display = (els.qualitySelect.value === 'custom') ? 'grid' : 'none';
          els.mode.value = 'single';
          setStatus('Choose a quality (or Custom) and click Download.', 0);
        }
      } catch (e) {
        setStatus('Error: ' + e.message, null, true);
      }
    }
    function buildSingleQualityString() {
      const choice = els.qualitySelect.value;
      if (choice === 'custom') {
        const v = els.videoSelect.value;
        const a = els.audioSelect.value;
        if (!v || !a) return '';
        return `${v}+${a}`;
      }
      if (choice === 'auto1080') return 'bv*[height<=1080][vcodec!=none][acodec=none]+ba';
      if (choice === 'auto720')  return 'bv*[height<=720][vcodec!=none][acodec=none]+ba';
      if (choice === 'auto480')  return 'bv*[height<=480][vcodec!=none][acodec=none]+ba';
      if (choice === 'auto360')  return 'bv*[height<=360][vcodec!=none][acodec=none]+ba';
      return '';
    }
    function startDownload() {
      if (!validatePath()) { setStatus('Output path is required.', null, true); return; }
      stopSSE();
      const url = analyzedUrl || els.yturl.value.trim();
      if (!url) { setStatus('Paste a URL and Analyze first.', null, true); return; }

      let mode = els.mode.value;
      if (isPlaylistUrl(url)) mode = 'playlist';

      const out = els.outDir.value.trim();
      const params = new URLSearchParams({ url, download_path: out, is_playlist: String(mode === 'playlist') });
      if (mode !== 'playlist') {
        const q = buildSingleQualityString();
        if (!q) { setStatus('Please choose a quality or select both custom formats.', null, true); return; }
        params.set('quality', q);
      }

      setStatus('Startingâ€¦', 0);
      sse = new EventSource('/progress?' + params.toString());
      sse.onmessage = (ev) => {
        try {
          const data = JSON.parse(ev.data);
          if (data.status === 'starting') setStatus('Startingâ€¦', 0);
          else if (data.status === 'downloading') {
            const pct = (data.percent != null) ? data.percent : null;
            const pctText = (pct != null) ? data.percent.toFixed(1) + '%' : '';
            setStatus(`Downloading ${pctText} â€” ${data.size} at ${data.speed} â€” ETA ${data.eta}`, pct);
          } else if (data.status === 'destination') setStatus('Saving to: ' + data.message);
          else if (data.status === 'already') setStatus('Already downloaded. ' + data.message);
          else if (data.status === 'merging') setStatus('Mergingâ€¦');
          else if (data.status === 'postprocess') setStatus('Post-processingâ€¦');
          else if (data.status === 'finished') { setStatus('Finished!', 100); stopSSE(); }
          else if (data.status === 'error') { setStatus('Error: ' + data.message, null, true); stopSSE(); }
        } catch (e) {
          setStatus('Stream error: ' + e.message, null, true);
          stopSSE();
        }
      };
      sse.onerror = () => { setStatus('Connection lost.', null, true); stopSSE(); };
    }
    function initDownloaderPage() {
      initDownloaderRefs();
      if (!els.yturl) return;
      els.outDir.addEventListener('input', validatePath);
      els.qualitySelect.addEventListener('change', () => {
        els.customFormats.style.display = (els.qualitySelect.value === 'custom') ? 'grid' : 'none';
      });
      els.btnGet.addEventListener('click', analyze);
      els.btnClear.addEventListener('click', () => { els.yturl.value=''; resetUI(true); });
      els.btnDownload.addEventListener('click', startDownload);
      els.btnStop.addEventListener('click', stopSSE);
      els.yturl.addEventListener('keydown', (e) => { if (e.key === 'Enter') analyze(); });
      validatePath();
    }

    // Settings page logic (local storage only)
    const settings = {
      key: 'tubemate_settings_v1',
      get() { try { return JSON.parse(localStorage.getItem(this.key) || '{}'); } catch { return {}; } },
      set(obj) { localStorage.setItem(this.key, JSON.stringify(obj)); }
    };
    function initSettingsUI() {
      const defOut = document.getElementById('defaultOut');
      const rememberUrl = document.getElementById('rememberUrl');
      const btnSave = document.getElementById('btnSaveSettings');
      const btnReset = document.getElementById('btnResetSettings');
      if (!defOut || !rememberUrl) return;

      function apply() {
        const s = settings.get();
        defOut.value = s.defaultOut || '~/Downloads';
        rememberUrl.value = s.rememberUrl === 'no' ? 'no' : 'yes';
        // Also push to downloader page default path if present
        if (els.outDir) els.outDir.value = s.defaultOut || '~/Downloads';
      }
      function save() {
        const s = settings.get();
        s.defaultOut = defOut.value.trim() || '~/Downloads';
        s.rememberUrl = rememberUrl.value;
        settings.set(s);
        alert('Settings saved.');
      }
      function reset() { localStorage.removeItem(settings.key); apply(); alert('Settings reset.'); }

      apply();
      btnSave && btnSave.addEventListener('click', save);
      btnReset && btnReset.addEventListener('click', reset);
    }

    // Boot
    document.addEventListener('DOMContentLoaded', () => {
      renderRoute();
      initDownloaderPage(); // downloader refs are present in DOM from start
    });
  </script>
</body>
</html>
